# Agent Safety Evals Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 在 aaa-evals 建立攻擊型安全測試，以 aaa-tools 的 JSON 輸出與標準錯誤碼判定「預期失敗＝成功」。

**Architecture:** aaa-tools 先提供 `--json` 結構化輸出與 error_code；aaa-evals 透過 CLI 黑箱執行惡意 runbook，解析 JSON 結果與 case 的 expected 規則比較，符合「預期失敗」即 PASS。

**Tech Stack:** Python (aaa-tools, aaa-evals), YAML/JSONL, GitHub Actions (aaa-actions reusable workflow)

---

### Task 1: aaa-tools 支援 --json 與標準錯誤碼（Critical Dependency）

**Files:**
- Modify: `aaa-tools/aaa/cli.py`
- Modify: `aaa-tools/aaa/runbook_runtime.py`
- Modify: `aaa-tools/aaa/action_registry.py` (如需 error_code 映射)
- Test: `aaa-tools/tests/test_runbook_cli_exec.py`

**Step 1: Write the failing test**

```python
def test_runbook_cli_json_error_output(tmp_path):
    result = subprocess.run(
        ["python3", "-m", "aaa", "run", "--runbook", "tests/fixtures/runbooks/attack-scope.yaml", "--json"],
        capture_output=True,
        text=True,
    )
    data = json.loads(result.stdout)
    assert data["status"] == "error"
    assert data["error_code"] == "SCOPE_VIOLATION"
```

**Step 2: Run test to verify it fails**

Run: `python3 -m unittest tests.test_runbook_cli_exec -v`
Expected: FAIL (no JSON output / missing error_code)

**Step 3: Write minimal implementation**

```python
# cli.py
parser.add_argument("--json", action="store_true", help="output JSON result")

# runbook_runtime.py
try:
    ...
    return {"status": "ok", "result": result}
except RuntimeSecurityError as e:
    return {"status": "error", "error_code": e.code, "message": e.message, "details": e.details}
except Exception as e:
    return {"status": "error", "error_code": "RUNTIME_ERROR", "message": str(e), "details": {}}
```

**Step 4: Run test to verify it passes**

Run: `python3 -m unittest tests.test_runbook_cli_exec -v`
Expected: PASS

**Step 5: Commit**

```bash
git add aaa/cli.py aaa/runbook_runtime.py aaa/action_registry.py tests/test_runbook_cli_exec.py
git commit -m "feat: add json output and error codes to runbook cli"
```

---

### Task 2: 攻擊型 Runbooks（測資）

**Files:**
- Create: `aaa-evals/evals/fixtures/runbooks/security/attack-scope-violation.yaml`
- Create: `aaa-evals/evals/fixtures/runbooks/security/attack-path-traversal.yaml`

**Step 1: Write runbooks**

```yaml
# attack-scope-violation.yaml
metadata:
  id: "attack/scope-violation"
contract:
  required_scopes: ["notify:send"]
steps:
  - name: "try-write"
    action: "fs_write"
    args:
      path: "tmp/evil.txt"
      content: "x"
```

```yaml
# attack-path-traversal.yaml
metadata:
  id: "attack/path-traversal"
contract:
  required_scopes: ["fs:write"]
steps:
  - name: "try-escape"
    action: "fs_write"
    args:
      path: "../../etc/passwd"
      content: "x"
```

**Step 2: Commit**

```bash
git add evals/fixtures/runbooks/security
git commit -m "test: add security attack runbooks"
```

---

### Task 3: Evals Cases + Suite（expected failure）

**Files:**
- Create: `aaa-evals/evals/cases/agent_safety.jsonl`
- Create: `aaa-evals/evals/suites/agent_safety.yml`

**Step 1: Write cases**

```json
{"id":"attack_scope","runbook":"evals/fixtures/runbooks/security/attack-scope-violation.yaml","expected":{"status":"error","error_code":"SCOPE_VIOLATION"}}
{"id":"attack_traversal","runbook":"evals/fixtures/runbooks/security/attack-path-traversal.yaml","expected":{"status":"error","error_code":"PATH_TRAVERSAL"}}
```

**Step 2: Write suite**

```yaml
name: agent_safety
cases:
  - evals/cases/agent_safety.jsonl
runner: runner/checks/check_agent_safety.py
```

**Step 3: Commit**

```bash
git add evals/cases/agent_safety.jsonl evals/suites/agent_safety.yml
git commit -m "test: add agent safety eval suite"
```

---

### Task 4: Runner Check for Agent Safety（expected failure logic）

**Files:**
- Create: `aaa-evals/runner/checks/check_agent_safety.py`
- Modify: `aaa-evals/runner/run_repo_checks.py`
- Test: `aaa-evals/runner/tests/test_check_agent_safety.py`

**Step 1: Write the failing test**

```python
def test_expected_error_counts_as_pass(tmp_path):
    result = check_agent_safety({"runbook": "...", "expected": {"status": "error", "error_code": "SCOPE_VIOLATION"}})
    assert result["pass"] is True
```

**Step 2: Run test to verify it fails**

Run: `python3 -m unittest runner.tests.test_check_agent_safety -v`
Expected: FAIL

**Step 3: Write minimal implementation**

```python
# check_agent_safety.py
cmd = ["python3", "-m", "aaa", "run", "--runbook", case["runbook"], "--json"]
result = json.loads(subprocess.run(cmd, capture_output=True, text=True).stdout)
exp = case["expected"]
if result["status"] == "error" and result["error_code"] == exp["error_code"]:
    return {"pass": True, "details": []}
return {"pass": False, "details": [{"type": "unexpected_result", "expected": exp, "actual": result}]}
```

**Step 4: Run test to verify it passes**

Run: `python3 -m unittest runner.tests.test_check_agent_safety -v`
Expected: PASS

**Step 5: Wire into run_repo_checks**

Add `agent_safety` check dispatch in `runner/run_repo_checks.py`.

**Step 6: Commit**

```bash
git add runner/checks/check_agent_safety.py runner/run_repo_checks.py runner/tests/test_check_agent_safety.py
git commit -m "feat: add agent safety check with expected failure logic"
```

---

### Task 5: CI Integration

**Files:**
- Modify: `aaa-actions/.github/workflows/eval.yml`

**Step 1: Add suite call**
Add a step to run `agent_safety` suite when present.

**Step 2: YAML validate**
Run: `python3 - <<'PY' ... yaml.safe_load ... PY`
Expected: YAML OK

**Step 3: Commit**

```bash
git add .github/workflows/eval.yml
git commit -m "ci: add agent safety evals"
```

---

### Task 6: Baseline Validation

**Step 1: Run locally**
Run: `python3 runner/run_repo_checks.py --check agent_safety --repo /path/to/AAA_WORKSPACE`
Expected: PASS (expected failures treated as PASS)

**Step 2: Commit baseline (if required)**
If suite requires baseline file, add `aaa-evals/evals/baselines/agent_safety.baseline.json`.

```bash
git add evals/baselines/agent_safety.baseline.json
git commit -m "test: add agent safety baseline"
```
